<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日本不動產投資與商業模式財務分析</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1a4f72;
            --secondary-color: #f0b90b;
            --background-color: #fdfdfd;
            --text-color: #333;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
        }
        body {
            font-family: 'Noto Sans TC', "Microsoft JhengHei", Arial, sans-serif;
            line-height: 1.8;
            color: #444;
            background-color: #eef1f5;
            padding: 20px;
        }
        .report-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border-radius: 10px;
            overflow: hidden;
        }
        .report-header {
            background-color: #1a4f72;
            color: #fff;
            padding: 30px 40px;
            border-bottom: 5px solid #f0b90b;
        }
        .report-header h1 {
            color: #fff;
            margin: 0;
            font-size: 28px;
            font-weight: 700;
        }
        .report-header p {
            margin: 5px 0 0;
            opacity: 0.9;
        }
        .report-body {
            padding: 30px 40px;
        }
        .section {
            margin-bottom: 40px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 25px;
        }
        .section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1a4f72;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0b90b;
        }
        h3 {
            font-size: 20px;
            font-weight: 500;
            color: #333;
            margin-bottom: 15px;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        .grid-container-large {
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 15px;
        }
        .expert-marker {
            color: #f0b90b;
            font-weight: 700;
            cursor: help;
            margin-left: 4px;
        }
        select, input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #1a4f72;
        }
        .btn-group {
            text-align: right;
            margin-top: 20px;
        }
        .btn {
            background-color: #1a4f72;
            color: #fff;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 16px;
            transition: background-color 0.3s;
            margin-left: 10px;
        }
        .btn:hover {
            background-color: #0d3c5a;
        }
        .btn-download {
            background-color: #f0b90b;
            color: #1a4f72;
        }
        .btn-download:hover {
            background-color: #d8a60a;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 15px;
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 14px;
            text-align: left;
            vertical-align: middle;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 500;
        }
        td:nth-child(2), td:nth-child(3) {
            text-align: right;
            font-family: monospace, 'Noto Sans TC';
        }
        
        /* 年度資產變化表的金額列靠右對齊 */
        #annual-projections table td:nth-child(2),
        #annual-projections table td:nth-child(3),
        #annual-projections table td:nth-child(4),
        #annual-projections table td:nth-child(5) {
            text-align: right;
            font-family: monospace, 'Noto Sans TC';
        }
        .summary-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #1a4f72;
        }
        .info-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background-color: #6c757d;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            cursor: help;
            margin-left: 8px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 320px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 10;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 13px;
            line-height: 1.5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .hidden {
            display: none;
        }
        #resultsContainer {
            margin-top: 40px;
        }
        .positive {
            color: #28a745; /* Green for profit */
            font-weight: 500;
        }
        .negative {
            color: #dc3545; /* Red for loss */
            font-weight: 500;
        }
        .section-description {
            font-size: 15px;
            color: #6c757d;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .suggestion-box {
            background-color: #eef7ff;
            border-left: 5px solid var(--primary-color);
            padding: 20px;
            margin-top: 15px;
            border-radius: 5px;
            line-height: 1.7;
        }
        .suggestion-box p {
            margin: 0 0 15px 0;
        }
         .suggestion-box ul {
            margin-top: 0;
            padding-left: 20px;
        }
        .suggestion-box li {
            margin-bottom: 10px;
        }
        .highlight-row {
            background-color: #f8f9fa;
            font-weight: 700;
        }
        .value-cell {
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="report-container" id="reportToPrint">
        <div class="report-header">
            <h1>日本不動產投資與商業模式財務分析</h1>
            <p>為專業投資者訂製的財務可行性評估</p>
        </div>

        <div class="report-body">
            <div class="section" id="parameters">
                <h2>第一章：基本參數設定</h2>
                <div class="grid-container">
                    <div class="form-group">
                        <label for="purchaseType">購買身份</label>
                        <select id="purchaseType">
                            <option value="personal">個人身份</option>
                            <option value="corporate" selected>設立法人</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="monetizationModel">
                            變現模式
                             <div class="tooltip">
                                <span class="expert-marker">★</span>
                                <span class="tooltiptext">選擇不同的變現模式，將會完全改變營運參數的設定與營收的計算方式。</span>
                            </div>
                        </label>
                        <select id="monetizationModel">
                            <option value="airbnb" selected>Airbnb 短租</option>
                            <option value="personalLease">個人長租</option>
                            <option value="commercialLease">店鋪出租</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="propertyType">
                            房產類型
                            <div class="tooltip">
                                <span class="expert-marker">★</span>
                                <span class="tooltiptext">選擇不同房型將自動更新房價、租金、建物結構及相關成本的專家建議值，以反映市場實況。</span>
                            </div>
                        </label>
                        <select id="propertyType">
                            <option value="1LDK" selected>1LDK</option>
                            <option value="2LDK">2LDK</option>
                            <option value="tower">塔樓</option>
                            <option value="house">一戶建</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="location">
                            房產位置 (東京23區)
                            <div class="tooltip">
                                <span class="expert-marker">★</span>
                                <span class="tooltiptext">選擇不同區域將連動更新房價與租金等專家建議值。目前模型以東京23區為基礎。</span>
                            </div>
                        </label>
                        <select id="location">
                            <optgroup label="都心5區 (Tier 1 - 高價區)">
                                <option value="Minato">港區</option>
                                <option value="Chiyoda">千代田區</option>
                                <option value="Chuo">中央區</option>
                                <option value="Shibuya">澀谷區</option>
                                <option value="Shinjuku">新宿區</option>
                            </optgroup>
                            <optgroup label="人氣職住區 (Tier 2 - 中高價區)">
                                <option value="Meguro">目黑區</option>
                                <option value="Setagaya">世田谷區</option>
                                <option value="Shinagawa">品川區</option>
                                <option value="Bunkyo">文京區</option>
                                <option value="Taito">台東區</option>
                                <option value="Toshima">豐島區</option>
                            </optgroup>
                            <optgroup label="標準住宅區 (Tier 3 - 標準區)">
                                <option value="Koto" selected>江東區</option>
                                <option value="Ota">大田區</option>
                                <option value="Suginami">杉並區</option>
                                <option value="Nakano">中野區</option>
                                <option value="Arakawa">荒川區</option>
                                <option value="Sumida">墨田區</option>
                                <option value="Itabashi">板橋區</option>
                                <option value="Nerima">練馬區</option>
                                <option value="Kita">北區</option>
                            </optgroup>
                            <optgroup label="東部/北部區 (Tier 4 - 實惠區)">
                                <option value="Adachi">足立區</option>
                                <option value="Katsushika">葛飾區</option>
                                <option value="Edogawa">江戶川區</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="loanOrigin">貸款來源</label>
                        <select id="loanOrigin">
                            <option value="japan">日本貸款</option>
                            <option value="taiwan">台灣貸款</option>
                            <option value="mixed">台灣信貸(頭期款) + 日本貸款</option>
                        </select>
                    </div>
                </div>

                <h3>1.1 房產與財務參數</h3>
                <div class="grid-container">
                    <div class="form-group">
                        <label for="propertyPrice">房產價格 (万円)</label>
                        <input type="text" inputmode="decimal" id="propertyPrice" value="3000">
                    </div>
                    <div class="form-group">
                        <label for="downPaymentRatio">頭期款比例 (%)</label>
                        <input type="number" id="downPaymentRatio" value="20" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="acquisitionCostRatio">
                            初期購屋總成本比例 (%)
                            <div class="tooltip">
                                <span class="expert-marker">★</span>
                                <span class="tooltiptext">包含仲介費、代書費、稅金等，佔房價的比例依物件價格而異。高價物件(如5000萬日幣以上)佔比較低，約6-8%；中低價物件佔比較高，約8-10%。8%為一綜合估算值。</span>
                            </div>
                        </label>
                        <input type="number" id="acquisitionCostRatio" value="8" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="initialFurnishingCost">
                            初期家具家電設置費用 (万円)
                            <div class="tooltip">
                                <span class="expert-marker">★</span>
                                <span class="tooltiptext">此為一次性投入的成本，用於購買經營所需的家具、家電、寢具、餐具等。對於Airbnb模式尤其重要。此費用將計入您的總投資額。</span>
                            </div>
                        </label>
                        <input type="text" inputmode="decimal" id="initialFurnishingCost" value="100">
                    </div>
                    <div class="form-group corporate-param hidden">
                        <label for="corporateSetupCost">
                            法人設立費用 (万円)
                            <div class="tooltip">
                                <span class="expert-marker">★</span>
                                <span class="tooltiptext">設立株式會社或合同會社所需的一次性行政、代書費用。此費用將計入您的總投資額。</span>
                            </div>
                        </label>
                        <input type="text" inputmode="decimal" id="corporateSetupCost" value="25">
                    </div>
                    
                    <div class="form-group loan-param hidden" data-loan-type="japan mixed">
                        <label for="japanLoanInterestRate">日本房貸利率 (%)</label>
                        <input type="number" id="japanLoanInterestRate" value="2.5" step="0.01">
                    </div>
                    <div class="form-group loan-param hidden" data-loan-type="japan mixed">
                        <label for="japanLoanTerm">日本貸款年限</label>
                        <input type="number" id="japanLoanTerm" value="25" min="1" max="35">
                    </div>

                    <div class="form-group loan-param hidden" data-loan-type="mixed">
                        <label for="ownCapitalAmount">
                            自備款金額 (万円)
                            <div class="tooltip">
                                <span class="expert-marker">★</span>
                                <span class="tooltiptext">請輸入頭期款中，您打算投入的自有資金金額。剩餘的頭期款將被視為透過信貸取得。</span>
                            </div>
                        </label>
                        <input type="text" inputmode="decimal" id="ownCapitalAmount" value="0">
                    </div>

                    <div class="form-group loan-param hidden" data-loan-type="taiwan">
                        <label for="taiwanLoanInterestRate">台灣房貸利率 (%)</label>
                        <input type="number" id="taiwanLoanInterestRate" value="2.1" step="0.01">
                    </div>
                    <div class="form-group loan-param hidden" data-loan-type="taiwan">
                        <label for="taiwanLoanTerm">台灣貸款年限</label>
                        <input type="number" id="taiwanLoanTerm" value="20" min="1" max="30">
                    </div>

                    <div class="form-group loan-param hidden" data-loan-type="mixed">
                        <label for="creditLoanRate">
                            台灣信貸利率 (%)
                            <div class="tooltip">
                                <span class="expert-marker">★</span>
                                <span class="tooltiptext">此為參考值，實際利率將依個人信用狀況而定。</span>
                            </div>
                        </label>
                        <input type="number" id="creditLoanRate" value="4.5" step="0.01">
                    </div>

                    <div class="form-group">
                        <label for="exchangeRate">日幣兌換台幣匯率</label>
                        <input type="number" id="exchangeRate" value="0.22" step="0.01">
                    </div>
                </div>

                <h3>1.2 營運參數</h3>
                
                <div id="airbnbParams">
                    <div class="grid-container grid-container-large">
                        <div class="form-group">
                            <label for="operatingDaysCap">合法經營天數上限</label>
                            <input type="number" id="operatingDaysCap" value="180">
                        </div>
                        <div class="form-group">
                            <label for="occupancyRate">預期入住率 (於合法天數內)(%)</label>
                            <input type="number" id="occupancyRate" value="80" max="100">
                        </div>
                        <div class="form-group">
                            <label for="dailyRate">
                                預期每日平均租金 (ADR) (日幣)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">此為根據東京市場實務的建議值。ADR會因地段、季節、屋況和評價而有顯著差異，建議參考鄰近房源定價後調整。</span>
                                </div>
                            </label>
                            <input type="text" inputmode="decimal" id="dailyRate" value="13000">
                        </div>
                        <div class="form-group">
                            <label for="platformFeeRate">
                                平台服務費率 (%)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">此為根據日本市場實務的建議值。Airbnb標準拆帳費率約15%。</span>
                                </div>
                            </label>
                            <input type="number" id="platformFeeRate" value="15" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="cleaningFee">
                                每次入住清潔費 (万円)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">此為根據東京市場實務的建議值。費用需涵蓋清潔人員薪資、交通以及消耗品（如洗髮精、毛巾）的補充。</span>
                                </div>
                            </label>
                            <input type="text" inputmode="decimal" id="cleaningFee" value="0.5">
                        </div>
                        <div class="form-group">
                            <label for="avgStayDuration">平均入住天數</label>
                            <input type="number" id="avgStayDuration" value="4">
                        </div>
                         <div class="form-group">
                            <label for="maxOccupancy">
                                最大收容人數
                                 <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">此建議值會根據房產類型自動調整。一戶建通常能容納更多人數，是其主要賣點之一。</span>
                                </div>
                            </label>
                            <input type="number" id="maxOccupancy" value="4">
                        </div>
                         <div class="form-group">
                            <label for="avgGuests">
                                平均入住人數
                                 <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">預估平均每筆訂單的實際入住人數，此數值將用於計算追加人頭費的收入。</span>
                                </div>
                            </label>
                            <input type="number" id="avgGuests" value="2">
                        </div>
                         <div class="form-group">
                            <label for="baseOccupancyForFee">
                                追加費用起算人數
                                 <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">當入住人數超過此設定值時，將開始計算追加費用。</span>
                                </div>
                            </label>
                            <input type="number" id="baseOccupancyForFee" value="2">
                        </div>
                         <div class="form-group">
                            <label for="extraGuestFee">
                                每人每晚追加費用
                                 <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">超過起算人數後，每位額外房客每晚需支付的費用。這是一戶建或大型房源的重要收入來源。</span>
                                </div>
                            </label>
                            <input type="text" inputmode="decimal" id="extraGuestFee" value="0.2">
                        </div>
                        <div class="form-group">
                            <label for="peakSeasonMarkup">
                                旺季加成比例 (%)
                                 <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">預估在旅遊旺季（如櫻花季、暑假、黃金週）時，ADR可比平時高出的百分比。模型將假設每年有3個月旺季進行估算。</span>
                                </div>
                            </label>
                            <input type="number" id="peakSeasonMarkup" value="15">
                        </div>
                        <div class="form-group">
                            <label for="monthlyUtilities">
                                每月水電瓦斯網路費 (万円)
                                 <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">此為根據東京市場實務的建議值。此估算已考量到旅客使用能源的習慣（通常較高）以及高速網路的必要性。一戶建因獨立性，費用通常最高。</span>
                                </div>
                            </label>
                            <input type="text" inputmode="decimal" id="monthlyUtilities" value="2.5">
                        </div>
                    </div>
                </div>

                <div id="personalLeaseParams" class="hidden">
                    <div class="grid-container">
                        <div class="form-group">
                            <label for="monthlyRent">
                                預估月租金 (万円)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">根據地點與房型估算的每月穩定租金收入。</span>
                                </div>
                            </label>
                            <input type="text" inputmode="decimal" id="monthlyRent" value="15">
                        </div>
                        <div class="form-group">
                            <label for="vacancyRate">
                                預估空置率 (%)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">根據東京市場，住宅空置率約在5-10%之間，取決於地點與物件條件。</span>
                                </div>
                            </label>
                            <input type="number" id="vacancyRate" value="8">
                        </div>
                        <div class="form-group">
                            <label for="initialLeaseCostsRatio">
                                初期費用收入 (月租金倍數)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">包含禮金、押金、保證公司費等，通常可收到2-4個月的租金作為初期收入。此部分收入僅在第一年計算。</span>
                                </div>
                            </label>
                            <input type="number" id="initialLeaseCostsRatio" value="2.5">
                        </div>
                         <div class="form-group">
                            <label for="leaseUtilities">
                                每月建物維護雜費 (万円)
                                 <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">長租模式下，租客自付水電瓦斯。此處僅估算房東需負擔的公共區域電費、網路等基本開銷。</span>
                                </div>
                            </label>
                            <input type="text" inputmode="decimal" id="leaseUtilities" value="0.5">
                        </div>
                        <div class="form-group">
                            <label for="leaseRenewalFeeFrequency">
                                更新料收取頻率 (年)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">日本長租契約通常每2年更新一次，屆時房東可收取一筆更新料作為額外收入。</span>
                                </div>
                            </label>
                            <input type="number" id="leaseRenewalFeeFrequency" value="2">
                        </div>
                        <div class="form-group">
                            <label for="leaseRenewalFeeAmount">
                                更新料 (月租金倍數)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">更新料的金額通常是1個月的租金。此為續約時的一次性收入。</span>
                                </div>
                            </label>
                            <input type="number" id="leaseRenewalFeeAmount" value="1">
                        </div>
                    </div>
                </div>

                <div id="commercialLeaseParams" class="hidden">
                    <div class="grid-container">
                        <div class="form-group">
                            <label for="monthlyRentCommercial">
                                預估月租金 (万円)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">店鋪租金高度依賴地點、樓層與面積。此為基於小型餐飲店的參考值。</span>
                                </div>
                            </label>
                            <input type="text" inputmode="decimal" id="monthlyRentCommercial" value="25">
                        </div>
                        <div class="form-group">
                            <label for="vacancyRateCommercial">
                                預估空置率 (%)
                                 <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">店鋪空置期風險較高，且更換租客的過渡期更長，建議保守估計，約10-15%。</span>
                                </div>
                            </label>
                            <input type="number" id="vacancyRateCommercial" value="12">
                        </div>
                        <div class="form-group">
                            <label for="initialLeaseCostsRatioCommercial">
                                初期費用收入 (月租金倍數)
                                 <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">店鋪的保證金/敷金通常較高(6-12個月)，但在租約結束時需退還。此處僅估算不退還的部分（如禮金、更新料）。</span>
                                </div>
                            </label>
                            <input type="number" id="initialLeaseCostsRatioCommercial" value="2">
                        </div>
                         <div class="form-group">
                            <label for="leaseTermCommercial">
                                租約年期
                                 <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">一般店鋪租約為2-5年，較長的租約能提供更穩定的現金流，但也會犧牲價格彈性。</span>
                                </div>
                            </label>
                            <input type="number" id="leaseTermCommercial" value="3">
                        </div>
                        <div class="form-group">
                            <label for="annualAppreciation">
                                不動產年均增值率 (%)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">此為相對保守的預估參考值，實際增值率高度依賴地點與市場狀況。</span>
                                </div>
                            </label>
                            <input type="number" id="annualAppreciation" value="0.5" step="0.1">
                        </div>
                         <div class="form-group">
                            <label for="investmentPeriod">投資持有年限</label>
                            <input type="number" id="investmentPeriod" value="10" min="1">
                        </div>
                        <div class="form-group">
                            <label for="annualInsuranceCost">
                                年均火災・地震保險料 (万円)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">此為重要的持有成本，通常在申請貸款時必須加入。費用會因建物結構、地區、保額而異。</span>
                                </div>
                            </label>
                            <input type="text" inputmode="decimal" id="annualInsuranceCost" value="2">
                        </div>
                        <div class="form-group corporate-param hidden">
                            <label for="annualTaxAccountantFee">
                                年均稅理士顧問費用 (万円)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">以法人身份營運時，處理帳務與稅務申報所需的專業費用。</span>
                                </div>
                            </label>
                            <input type="text" inputmode="decimal" id="annualTaxAccountantFee" value="20">
                        </div>
                    </div>
                </div>
                
                <h3>1.3 長期持有參數</h3>
                <div class="grid-container">
                    <div class="form-group">
                        <label for="managementFeeRatio">
                            物業管理與修繕金比例 (%)
                            <div class="tooltip">
                                <span class="expert-marker">★</span>
                                <span class="tooltiptext" id="managementFeeTooltip">此建議值會根據房產類型自動調整。塔樓因公設多，管理費高；一戶建則需考量自主維護成本。</span>
                            </div>
                        </label>
                        <input type="number" id="managementFeeRatio" value="8" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="propertyTaxRate">
                            固定資產稅與都市計畫稅率 (%)
                            <div class="tooltip">
                                <span class="expert-marker">★</span>
                                <span class="tooltiptext">此為根據日本市場實務的建議值。包含固定資產稅(標準1.4%)與都市計畫稅(標準0.3%)。</span>
                            </div>
                        </label>
                        <input type="number" id="propertyTaxRate" value="1.7" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="annualAppreciation">
                            不動產年均增值率 (%)
                            <div class="tooltip">
                                <span class="expert-marker">★</span>
                                <span class="tooltiptext">此為相對保守的預估參考值，實際增值率高度依賴地點與市場狀況。</span>
                            </div>
                        </label>
                        <input type="number" id="annualAppreciation" value="0.5" step="0.1">
                    </div>
                     <div class="form-group">
                        <label for="investmentPeriod">投資持有年限</label>
                        <input type="number" id="investmentPeriod" value="10" min="1">
                    </div>
                    <div class="form-group">
                        <label for="annualInsuranceCost">
                            年均火災・地震保險料 (万円)
                            <div class="tooltip">
                                <span class="expert-marker">★</span>
                                <span class="tooltiptext">此為重要的持有成本，通常在申請貸款時必須加入。費用會因建物結構、地區、保額而異。</span>
                            </div>
                        </label>
                        <input type="number" id="annualInsuranceCost" value="2">
                    </div>
                    <div class="form-group corporate-param hidden">
                        <label for="annualTaxAccountantFee">
                            年均稅理士顧問費用 (万円)
                            <div class="tooltip">
                                <span class="expert-marker">★</span>
                                <span class="tooltiptext">以法人身份營運時，處理帳務與稅務申報所需的專業費用。</span>
                            </div>
                        </label>
                        <input type="number" id="annualTaxAccountantFee" value="20">
                    </div>
                </div>

                <div id="taxParams" class="corporate-param hidden">
                    <h3>1.4 稅務參數 (法人適用)</h3>
                    <div class="grid-container">
                        <div class="form-group">
                            <label for="buildingStructure">
                                建物結構 (影響折舊年限)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext" id="buildingStructureTooltip">此建議值會根據房產類型自動調整。RC造耐用年限47年，木造為22年，直接影響稅務折舊金額。</span>
                                </div>
                            </label>
                            <select id="buildingStructure">
                                <option value="wood">木造 (耐用年数22年)</option>
                                <option value="rc" selected>RC/SRC造 (耐用年数47年)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="buildingRatio">
                                建物佔房價比例 (%)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext" id="buildingRatioTooltip">此建議值會根據房產類型自動調整。塔樓建物價值高，佔比高；一戶建土地價值高，佔比較低。此比例是計算折舊的基礎。</span>
                                </div>
                            </label>
                            <input type="number" id="buildingRatio" value="60">
                        </div>
                        <div class="form-group">
                            <label for="corporateTaxRate">
                                法人綜合實效稅率 (%)
                                <div class="tooltip">
                                    <span class="expert-marker">★</span>
                                    <span class="tooltiptext">此為根據日本市場實務的建議值，適用於課稅所得800万円以下的中小企業。</span>
                                </div>
                            </label>
                            <input type="number" id="corporateTaxRate" value="23.2">
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn" id="calculateBtn">生成分析報告</button>
                </div>
            </div>

            <div id="resultsContainer" class="hidden">
                <div class="section" id="financialAnalysis">
                    <h2>第二章：財務分析</h2>
                    <div class="summary-card">
                        <h3>投資回報總覽</h3>
                        <table>
                            <tr>
                                <th>關鍵績效指標 (KPI)</th>
                                <th>數值</th>
                            </tr>
                            <tr>
                                <td>
                                    現金回報率 (Cash-on-Cash Return)
                                    <div class="tooltip">
                                        <span class="info-icon">i</span>
                                        <span class="tooltiptext">穩定營運年度的淨現金流 ÷ 總投資金額 × 100%<br>此指標衡量您投入的現金每年能產生多少回報，是評估現金流效率的核心指標。</span>
                                    </div>
                                </td>
                                <td id="cashOnCashReturn" colspan="2">-</td>
                            </tr>
                            <tr>
                                <td>
                                    內部報酬率 (IRR)
                                    <div class="tooltip">
                                        <span class="info-icon">i</span>
                                        <span class="tooltiptext">綜合考慮投資期間所有現金流（包括年度淨現金流和最終出售時的資產淨值）後，使總投資淨現值為零的折現率。IRR是評估長期投資獲利能力的黃金標準。</span>
                                    </div>
                                </td>
                                <td id="totalROI" colspan="2">-</td>
                            </tr>
                            <tr>
                                <td>
                                    投資回收期 (Payback Period)
                                    <div class="tooltip">
                                        <span class="info-icon">i</span>
                                        <span class="tooltiptext">僅考慮營運現金流，回收初期總投資所需的時間。</span>
                                    </div>
                                </td>
                                <td id="paybackPeriod" colspan="2">-</td>
                            </tr>
                        </table>
                    </div>

                    <h3>初始投資成本分析</h3>
                    <div class="section-description">此表格清楚劃分了您為了取得此資產所需投入的所有資金來源與成本結構。所有數字皆為預估值。</div>
                    <table>
                        <thead>
                            <tr>
                                <th>項目</th>
                                <th>金額 (万円)</th>
                                <th>金額 (台幣)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    總投資金額
                                    <i class="fas fa-info-circle tooltip-trigger" title="您為了完成投資，真正需要從口袋裡拿出的現金總額。計算方式：[自備款] + [初期雜項開銷(仲介、稅費等)] + [家具家電與法人設立費]。此為評估啟動資金的關鍵數字。"></i>
                                </td>
                                <td id="totalInvestmentJPY">-</td>
                                <td id="totalInvestmentTWD">-</td>
                            </tr>
                            <tr>
                                <td>
                                    總購屋成本
                                    <i class="fas fa-info-circle tooltip-trigger" title="取得此房產的「帳面總成本」，主要用於計算未來資產折舊與資本利得稅。計算方式：[房屋價格] + [初期雜項開銷(仲介、稅費等)]。"></i>
                                </td>
                                <td id="totalCostJPY">-</td>
                                <td id="totalCostTWD">-</td>
                            </tr>
                            <tr>
                                <td>
                                    自備款 (頭期款內)
                                    <i class="fas fa-info-circle tooltip-trigger" title="您在頭期款中，以自有資金支付的部分。此金額直接取自您輸入的「自備款日幣金額」。"></i>
                                </td>
                                <td id="downPaymentOwnCapitalJPY">-</td>
                                <td id="downPaymentOwnCapitalTWD">-</td>
                            </tr>
                            <tr>
                                <td>
                                    頭期款信貸金額
                                    <i class="fas fa-info-circle tooltip-trigger" title="當「自備款」不足以支付「總頭期款」時，由信用貸款補足的差額。計算方式：[總頭期款] - [自備款]。"></i>
                                </td>
                                <td id="downPaymentCreditLoanJPY">-</td>
                                <td id="downPaymentCreditLoanTWD">-</td>
                            </tr>
                            <tr>
                                <td>
                                    房貸金額
                                    <i class="fas fa-info-circle tooltip-trigger" title="您向銀行申請的主要房屋貸款金額。計算方式：[房屋價格] - [總頭期款]。"></i>
                                </td>
                                <td id="loanAmountJPY">-</td>
                                <td id="loanAmountTWD">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="cash-flow-details" class="result-section">
                    <h4 style="margin-top: 20px;">現金流分析 (Cash Flow Analysis) <i class="fas fa-info-circle tooltip-trigger" title="此表格顯示了您在持有期間每年的預估現金流動情況。第一年包含了一次性的收入，續年則為穩定的營運狀態。"></i></h4>
                    <table class="results-table" id="cashFlowAnalysisTable">
                        <thead>
                            <tr class="header-row">
                                <th>項目</th>
                                <th>第一年現金流 (万円)</th>
                                <th>續年現金流 (万円)</th>
                            </tr>
                        </thead>
                        <tbody id="cashFlowBreakdown">
                            <!-- JS will populate this -->
                        </tbody>
                        <tfoot class="total-row">
                            <tr>
                                <td><strong>稅後淨現金流</strong></td>
                                <td id="netCashFlow_y1" class="value-cell"></td>
                                <td id="netCashFlow_y2" class="value-cell"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div id="annual-projections" class="result-section">
                    <h4>年度資產變化表 (Annual Projections) <i class="fas fa-info-circle tooltip-trigger" title="此表格追蹤了您的資產淨值隨時間的變化，考慮了房產增值與貸款本金的償還。"></i></h4>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>年度</th>
                                <th>稅後現金流 (万円)</th>
                                <th>預估房產價值 (万円)</th>
                                <th>貸款餘額 (万円)</th>
                                <th>淨資產價值 (万円)</th>
                            </tr>
                        </thead>
                        <tbody id="annualTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="section hidden" id="expertSuggestions">
                    <h2>第五章：專家綜合建議</h2>
                    <div id="suggestionText" class="suggestion-box"></div>
                </div>
            </div>

            <div class="btn-group" style="padding-bottom: 40px;">
                <button class="btn btn-download hidden" id="downloadBtn">下載完整報告 (PDF)</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.jspdf = window.jspdf.jsPDF;

            // --- FORMATTING HELPERS ---
            function formatOnBlur(event) {
                const input = event.target;
                const value = unformatNumber(input.value);
                if (!isNaN(value) && value.length > 0) {
                    input.value = parseFloat(value).toLocaleString('en-US');
                }
            }

            function unformatOnFocus(event) {
                const input = event.target;
                input.value = unformatNumber(input.value);
            }

            function unformatNumber(value) {
                return String(value).replace(/,/g, '');
            }

            function formatAllNumberInputs() {
                const inputsToFormat = [
                    'propertyPrice', 'initialFurnishingCost', 'corporateSetupCost', 'dailyRate', 'cleaningFee',
                    'extraGuestFee', 'monthlyUtilities', 'monthlyRent', 'leaseUtilities',
                    'monthlyRentCommercial', 'annualInsuranceCost', 'annualTaxAccountantFee', 'ownCapitalAmount'
                ];
                inputsToFormat.forEach(id => {
                    const input = document.getElementById(id);
                    if (input && input.offsetParent !== null) {
                        formatOnBlur({
                            target: input
                        });
                    }
                });
            }

            // --- ELEMENT SELECTORS ---
            const monetizationModelSelect = document.getElementById('monetizationModel');
            const purchaseTypeSelect = document.getElementById('purchaseType');
            const propertyTypeSelect = document.getElementById('propertyType');
            const locationSelect = document.getElementById('location');
            const loanOriginSelect = document.getElementById('loanOrigin');
            const calculateBtn = document.getElementById('calculateBtn');
            const downloadBtn = document.getElementById('downloadBtn');

            const airbnbParamsDiv = document.getElementById('airbnbParams');
            const personalLeaseParamsDiv = document.getElementById('personalLeaseParams');
            const commercialLeaseParamsDiv = document.getElementById('commercialLeaseParams');
            const taxParamsDiv = document.getElementById('taxParams');
            const resultsContainer = document.getElementById('resultsContainer');

            // --- DATA ---
            const locationTiers = {
                'Minato': 'tier1',
                'Chiyoda': 'tier1',
                'Chuo': 'tier1',
                'Shibuya': 'tier1',
                'Shinjuku': 'tier1',
                'Meguro': 'tier2',
                'Setagaya': 'tier2',
                'Shinagawa': 'tier2',
                'Bunkyo': 'tier2',
                'Taito': 'tier2',
                'Toshima': 'tier2',
                'Koto': 'tier3',
                'Ota': 'tier3',
                'Suginami': 'tier3',
                'Nakano': 'tier3',
                'Arakawa': 'tier3',
                'Sumida': 'tier3',
                'Itabashi': 'tier3',
                'Nerima': 'tier3',
                'Kita': 'tier3',
                'Adachi': 'tier4',
                'Katsushika': 'tier4',
                'Edogawa': 'tier4'
            };

            const expertDefaults = { // adr in Yen, others in 万円
                'tier1': { '1LDK': { price: '4500', adr: 18000, rent: 20, com_rent: 32 }, '2LDK': { price: '6500', adr: 26000, rent: 28, com_rent: 45 }, 'tower': { price: '9000', adr: 38000, rent: 40, com_rent: 60 }, 'house': { price: '8500', adr: 32000, rent: 35, com_rent: 50 }},
                'tier2': { '1LDK': { price: '3800', adr: 15000, rent: 16, com_rent: 25 }, '2LDK': { price: '5500', adr: 22000, rent: 23, com_rent: 38 }, 'tower': { price: '7500', adr: 32000, rent: 35, com_rent: 55 }, 'house': { price: '7000', adr: 27000, rent: 30, com_rent: 45 }},
                'tier3': { '1LDK': { price: '3000', adr: 13000, rent: 12, com_rent: 20 }, '2LDK': { price: '4200', adr: 19000, rent: 17, com_rent: 30 }, 'tower': { price: '6500', adr: 28000, rent: 28, com_rent: 48 }, 'house': { price: '5800', adr: 24000, rent: 22, com_rent: 35 }},
                'tier4': { '1LDK': { price: '2500', adr: 11000, rent: 9, com_rent: 16 }, '2LDK': { price: '3500', adr: 16000, rent: 13, com_rent: 25 }, 'tower': { price: '5000', adr: 25000, rent: 22, com_rent: 40 }, 'house': { price: '4800', adr: 21000, rent: 18, com_rent: 30 }}
            };

            const typeSpecificDefaults = { // All values in 万円
                '1LDK':  { cleaning: 0.5, utilities: 2.5, structure: 'rc', buildingRatio: '60', mgmtFee: '8', maxOccupancy: 4, avgGuests: 2, baseOccupancy: 2, extraFee: 0.2, peakMarkup: 15 },
                '2LDK':  { cleaning: 0.7, utilities: 3.0, structure: 'rc', buildingRatio: '55', mgmtFee: '9', maxOccupancy: 6, avgGuests: 4, baseOccupancy: 3, extraFee: 0.25, peakMarkup: 20 },
                'tower': { cleaning: 0.85, utilities: 3.5, structure: 'rc', buildingRatio: '70', mgmtFee: '12', maxOccupancy: 5, avgGuests: 3, baseOccupancy: 2, extraFee: 0.3, peakMarkup: 25 },
                'house': { cleaning: 1, utilities: 4, structure: 'wood', buildingRatio: '40', mgmtFee: '2', maxOccupancy: 8, avgGuests: 5, baseOccupancy: 3, extraFee: 0.3, peakMarkup: 25 }
            };

            // --- EVENT LISTENERS ---
            purchaseTypeSelect.addEventListener('change', () => {
                const isCorporate = purchaseTypeSelect.value === 'corporate';
                document.querySelectorAll('.corporate-param').forEach(el => {
                    el.classList.toggle('hidden', !isCorporate);
                });
            });

            loanOriginSelect.addEventListener('change', () => {
                const selection = loanOriginSelect.value;
                document.querySelectorAll('.loan-param').forEach(el => {
                    el.classList.toggle('hidden', !el.dataset.loanType.includes(selection));
                });
            });

            monetizationModelSelect.addEventListener('change', () => {
                const model = monetizationModelSelect.value;
                airbnbParamsDiv.classList.toggle('hidden', model !== 'airbnb');
                personalLeaseParamsDiv.classList.toggle('hidden', model !== 'personalLease');
                commercialLeaseParamsDiv.classList.toggle('hidden', model !== 'commercialLease');
                updateDefaults();
            });

            propertyTypeSelect.addEventListener('change', updateDefaults);
            locationSelect.addEventListener('change', updateDefaults);

            calculateBtn.addEventListener('click', () => {
                try {
                    const results = calculateInvestment();
                    if (results) {
                        updateUI(results);
                        generateSuggestions(results);
                        resultsContainer.classList.remove('hidden');
                        downloadBtn.classList.remove('hidden');
                    }
                } catch (e) {
                    console.error("Calculation Error:", e);
                    alert("計算時發生錯誤，請檢查所有輸入欄位是否正確。\n錯誤訊息: " + e.message);
                }
            });

            downloadBtn.addEventListener('click', () => {
                const report = document.getElementById('reportToPrint');
                const btnGroup = report.querySelector('.btn-group');
                btnGroup.style.display = 'none';

                html2canvas(report, {
                    scale: 1.8, // Slightly reduced scale for smaller canvas size
                    useCORS: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 0.9); // Switched to JPEG with 90% quality
                    const pdf = new jspdf('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasWidth / canvasHeight;
                    const imgHeightInPdf = pdfWidth / ratio;
                    let heightLeft = imgHeightInPdf;
                    let position = 0;

                    pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeightInPdf); // Use 'JPEG' format
                    heightLeft -= pdf.internal.pageSize.getHeight();

                    while (heightLeft > 0) {
                        position -= pdf.internal.pageSize.getHeight();
                        pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeightInPdf); // Use 'JPEG' format
                        heightLeft -= pdf.internal.pageSize.getHeight();
                    }

                    pdf.save('日本不動產財務分析報告.pdf');
                    btnGroup.style.display = 'block';
                });
            });


            // --- FUNCTIONS ---
            function updateDefaults() {
                const location = locationSelect.value;
                const propertyType = propertyTypeSelect.value;
                const monetizationModel = monetizationModelSelect.value;

                const tier = locationTiers[location] || 'tier3';
                const locationBasedDefaults = expertDefaults[tier][propertyType];
                const typeBasedDefaults = typeSpecificDefaults[propertyType];

                document.getElementById('propertyPrice').value = locationBasedDefaults.price;

                if (monetizationModel === 'airbnb') {
                    document.getElementById('dailyRate').value = locationBasedDefaults.adr;
                } else if (monetizationModel === 'personalLease') {
                    document.getElementById('monthlyRent').value = locationBasedDefaults.rent;
                } else if (monetizationModel === 'commercialLease') {
                    document.getElementById('monthlyRentCommercial').value = locationBasedDefaults.com_rent;
                }

                document.getElementById('cleaningFee').value = typeBasedDefaults.cleaning;
                document.getElementById('monthlyUtilities').value = typeBasedDefaults.utilities;
                document.getElementById('buildingStructure').value = typeBasedDefaults.structure;
                document.getElementById('buildingRatio').value = typeBasedDefaults.buildingRatio;
                document.getElementById('managementFeeRatio').value = typeBasedDefaults.mgmtFee;
                document.getElementById('maxOccupancy').value = typeBasedDefaults.maxOccupancy;
                document.getElementById('avgGuests').value = typeBasedDefaults.avgGuests;
                document.getElementById('baseOccupancyForFee').value = typeBasedDefaults.baseOccupancy;
                document.getElementById('extraGuestFee').value = typeBasedDefaults.extraFee;
                document.getElementById('peakSeasonMarkup').value = typeBasedDefaults.peakMarkup;
                document.getElementById('ownCapitalAmount').value = 0;

                formatAllNumberInputs();
            }

            function calculateInvestment() {
                const MAN_EN = 10000;
                const monetizationModel = document.getElementById('monetizationModel').value;
                const purchaseType = document.getElementById('purchaseType').value;
                const propertyPrice = parseFloat(unformatNumber(document.getElementById('propertyPrice').value)) * MAN_EN;
                const downPaymentRatio = parseFloat(unformatNumber(document.getElementById('downPaymentRatio').value)) / 100;
                const acquisitionCostRatio = parseFloat(unformatNumber(document.getElementById('acquisitionCostRatio').value)) / 100;
                const exchangeRate = parseFloat(unformatNumber(document.getElementById('exchangeRate').value));
                const loanOrigin = document.getElementById('loanOrigin').value;
                const initialFurnishingCost = (parseFloat(unformatNumber(document.getElementById('initialFurnishingCost').value)) || 0) * MAN_EN;

                let loanInterestRate = 0,
                    loanTerm = 0;
                if (loanOrigin === 'japan' || loanOrigin === 'mixed') {
                    loanInterestRate = parseFloat(unformatNumber(document.getElementById('japanLoanInterestRate').value)) / 100;
                    loanTerm = parseInt(unformatNumber(document.getElementById('japanLoanTerm').value));
                } else if (loanOrigin === 'taiwan') {
                    loanInterestRate = parseFloat(unformatNumber(document.getElementById('taiwanLoanInterestRate').value)) / 100;
                    loanTerm = parseInt(unformatNumber(document.getElementById('taiwanLoanTerm').value));
                }
                const creditLoanRate = parseFloat(unformatNumber(document.getElementById('creditLoanRate').value)) / 100;
                const managementFeeRatio = parseFloat(unformatNumber(document.getElementById('managementFeeRatio').value)) / 100;
                const propertyTaxRate = parseFloat(unformatNumber(document.getElementById('propertyTaxRate').value)) / 100;
                const annualAppreciation = parseFloat(unformatNumber(document.getElementById('annualAppreciation').value)) / 100;
                const investmentPeriod = parseInt(unformatNumber(document.getElementById('investmentPeriod').value));
                const buildingStructure = document.getElementById('buildingStructure').value;
                const buildingRatio = parseFloat(unformatNumber(document.getElementById('buildingRatio').value)) / 100;
                const corporateTaxRate = parseFloat(unformatNumber(document.getElementById('corporateTaxRate').value)) / 100;
                const annualInsuranceCost = (parseFloat(unformatNumber(document.getElementById('annualInsuranceCost').value)) || 0) * MAN_EN;
                const corporateSetupCost = (purchaseType === 'corporate') ? ((parseFloat(unformatNumber(document.getElementById('corporateSetupCost').value)) || 0) * MAN_EN) : 0;
                const annualTaxAccountantFee = (purchaseType === 'corporate') ? ((parseFloat(unformatNumber(document.getElementById('annualTaxAccountantFee').value)) || 0) * MAN_EN) : 0;

                const totalUpfrontCosts = propertyPrice * acquisitionCostRatio;
                const totalCost = propertyPrice + totalUpfrontCosts;
                const downPaymentAmount = propertyPrice * downPaymentRatio;
                const loanAmount = propertyPrice - downPaymentAmount;

                let ownCapitalForDownPaymentAmount;
                let creditLoanForDownPaymentAmount;

                if (loanOrigin === 'mixed') {
                    const ownCapitalAmountInput = (parseFloat(unformatNumber(document.getElementById('ownCapitalAmount').value)) || 0) * MAN_EN;
                    ownCapitalForDownPaymentAmount = Math.min(ownCapitalAmountInput, downPaymentAmount);
                    creditLoanForDownPaymentAmount = downPaymentAmount - ownCapitalForDownPaymentAmount;
                } else {
                    ownCapitalForDownPaymentAmount = downPaymentAmount;
                    creditLoanForDownPaymentAmount = 0;
                }

                const totalInitialInvestment = ownCapitalForDownPaymentAmount + totalUpfrontCosts + initialFurnishingCost + corporateSetupCost;

                let monthlyGrossRevenue = 0,
                    monthlyOperatingExpenses = 0,
                    oneTimeInitialIncome = 0,
                    annualRenewalFee = 0;
                if (monetizationModel === 'airbnb') {
                    const operatingDaysCap = parseInt(unformatNumber(document.getElementById('operatingDaysCap').value)),
                        occupancyRate = parseFloat(unformatNumber(document.getElementById('occupancyRate').value)) / 100,
                        dailyRate = parseFloat(unformatNumber(document.getElementById('dailyRate').value)),
                        platformFeeRate = parseFloat(unformatNumber(document.getElementById('platformFeeRate').value)) / 100,
                        cleaningFee = parseFloat(unformatNumber(document.getElementById('cleaningFee').value)) * MAN_EN,
                        avgStayDuration = parseFloat(unformatNumber(document.getElementById('avgStayDuration').value)),
                        avgGuests = parseFloat(unformatNumber(document.getElementById('avgGuests').value)),
                        baseOccupancyForFee = parseFloat(unformatNumber(document.getElementById('baseOccupancyForFee').value)),
                        extraGuestFee = parseFloat(unformatNumber(document.getElementById('extraGuestFee').value)) * MAN_EN,
                        peakSeasonMarkup = parseFloat(unformatNumber(document.getElementById('peakSeasonMarkup').value)) / 100,
                        monthlyUtilities = parseFloat(unformatNumber(document.getElementById('monthlyUtilities').value)) * MAN_EN;
                    const annualBookedNights = operatingDaysCap * occupancyRate,
                        monthlyBookedNights = annualBookedNights / 12;
                    const totalEffectiveADR = dailyRate * (1 + peakSeasonMarkup * 3 / 12) + Math.max(0, avgGuests - baseOccupancyForFee) * extraGuestFee;
                    monthlyGrossRevenue = monthlyBookedNights * totalEffectiveADR;
                    const turnoversPerMonth = avgStayDuration > 0 ? monthlyBookedNights / avgStayDuration : 0;
                    monthlyOperatingExpenses = monthlyGrossRevenue * platformFeeRate + turnoversPerMonth * cleaningFee + monthlyUtilities;
                } else {
                    let monthlyRent, vacancyRate, initialRatio, leaseUtilities;
                    if (monetizationModel === 'personalLease') {
                        monthlyRent = parseFloat(unformatNumber(document.getElementById('monthlyRent').value)) * MAN_EN;
                        vacancyRate = parseFloat(unformatNumber(document.getElementById('vacancyRate').value)) / 100;
                        initialRatio = parseFloat(unformatNumber(document.getElementById('initialLeaseCostsRatio').value));
                        leaseUtilities = parseFloat(unformatNumber(document.getElementById('leaseUtilities').value)) * MAN_EN;
                        const leaseRenewalFeeFrequency = parseFloat(unformatNumber(document.getElementById('leaseRenewalFeeFrequency').value)) || 2;
                        const leaseRenewalFeeAmount = parseFloat(unformatNumber(document.getElementById('leaseRenewalFeeAmount').value)) || 0;
                        annualRenewalFee = (leaseRenewalFeeFrequency > 0 && leaseRenewalFeeAmount > 0) ? (monthlyRent * leaseRenewalFeeAmount) / leaseRenewalFeeFrequency : 0;
                    } else { // Commercial Lease
                        monthlyRent = parseFloat(unformatNumber(document.getElementById('monthlyRentCommercial').value)) * MAN_EN;
                        vacancyRate = parseFloat(unformatNumber(document.getElementById('vacancyRateCommercial').value)) / 100;
                        initialRatio = parseFloat(unformatNumber(document.getElementById('initialLeaseCostsRatioCommercial').value));
                        leaseUtilities = 0; // Typically tenant pays utilities for commercial
                    }
                    monthlyGrossRevenue = monthlyRent * (1 - vacancyRate);
                    oneTimeInitialIncome = monthlyRent * initialRatio;
                    monthlyOperatingExpenses = leaseUtilities;
                }

                const monthlyNetRevenue = monthlyGrossRevenue - monthlyOperatingExpenses;
                const monthlyPayment = loanAmount > 0 && loanTerm > 0 && loanInterestRate > 0 ? loanAmount * (loanInterestRate / 12 * Math.pow(1 + loanInterestRate / 12, loanTerm * 12)) / (Math.pow(1 + loanInterestRate / 12, loanTerm * 12) - 1) : (loanAmount > 0 && loanTerm > 0 ? loanAmount / (loanTerm * 12) : 0);
                const creditLoanPayment = (creditLoanForDownPaymentAmount > 0) ? creditLoanForDownPaymentAmount * (creditLoanRate / 12 * Math.pow(1 + creditLoanRate / 12, 60)) / (Math.pow(1 + creditLoanRate / 12, 60) - 1) : 0;
                const monthlyManagementAndRepairs = monthlyGrossRevenue * managementFeeRatio;
                const monthlyPropertyTax = (propertyPrice * propertyTaxRate) / 12;
                const totalAnnualExpenses = (monthlyPayment + creditLoanPayment + monthlyManagementAndRepairs + monthlyPropertyTax) * 12 + annualInsuranceCost + annualTaxAccountantFee;

                let cashFlows = [-totalInitialInvestment];
                let remainingLoan = loanAmount;
                const annualDepreciation = (propertyPrice * buildingRatio) / (buildingStructure === 'wood' ? 22 : 47);
                let annualTax_y1 = 0, annualTax_y2 = 0;


                for (let year = 1; year <= investmentPeriod; year++) {
                    const leaseRenewalFeeFrequency = parseFloat(unformatNumber(document.getElementById('leaseRenewalFeeFrequency').value)) || 2;
                    const isRenewalYear = (monetizationModel === 'personalLease' && annualRenewalFee > 0 && year > 0 && year % leaseRenewalFeeFrequency === 0);
                    const currentYearRenewalFee = isRenewalYear ? annualRenewalFee * leaseRenewalFeeFrequency : 0;

                    const annualIncome = monthlyNetRevenue * 12 + (year === 1 ? oneTimeInitialIncome : 0) + currentYearRenewalFee;

                    let annualInterestPaid = 0,
                        annualCreditInterestPaid = 0;

                    if (remainingLoan > 0 && monthlyPayment > 0) {
                        for (let m = 0; m < 12; m++) {
                            let interest = remainingLoan * (loanInterestRate / 12);
                            annualInterestPaid += interest;
                            let principal = monthlyPayment - interest;
                            remainingLoan -= principal;
                        }
                    }

                    let postTaxAnnualCashFlow = annualIncome - totalAnnualExpenses;

                    if (purchaseType === 'corporate') {
                        const annualManagementAndRepairsValue = monthlyManagementAndRepairs * 12;
                        const annualPropertyTaxValue = monthlyPropertyTax * 12;
                        const taxableIncome = (monthlyGrossRevenue * 12 + (year === 1 ? oneTimeInitialIncome : 0) + currentYearRenewalFee) -
                            (monthlyOperatingExpenses * 12) -
                            annualInterestPaid -
                            annualCreditInterestPaid -
                            annualManagementAndRepairsValue -
                            annualPropertyTaxValue -
                            annualInsuranceCost -
                            annualTaxAccountantFee -
                            annualDepreciation;
                        const annualTax = taxableIncome > 0 ? taxableIncome * corporateTaxRate : 0;
                        if(year === 1) annualTax_y1 = annualTax;
                        if(year === 2) annualTax_y2 = annualTax;
                        postTaxAnnualCashFlow -= annualTax;
                    }

                    if (year === investmentPeriod) {
                        const currentPropertyValue = propertyPrice * Math.pow(1 + annualAppreciation, year);
                        const sellingCosts = currentPropertyValue * 0.03;

                        let finalLoanBalance = loanAmount;
                        if (loanAmount > 0 && monthlyPayment > 0) {
                            for (let y = 0; y < investmentPeriod; y++) {
                                if (finalLoanBalance <= 0) break;
                                for (let m = 0; m < 12; m++) {
                                    const interest = finalLoanBalance * (loanInterestRate / 12);
                                    const principal = monthlyPayment - interest;
                                    finalLoanBalance -= principal;
                                }
                            }
                        }
                        finalLoanBalance = Math.max(0, finalLoanBalance);

                        let capitalGainsTax = 0;
                        if (purchaseType === 'corporate') {
                            const accumulatedDepreciation = annualDepreciation * investmentPeriod;
                            const buildingBookValue = (propertyPrice * buildingRatio) - accumulatedDepreciation;
                            const landValue = propertyPrice * (1 - buildingRatio);
                            const bookValue = buildingBookValue + landValue;
                            const capitalGain = currentPropertyValue - bookValue - sellingCosts;
                            if (capitalGain > 0) {
                                capitalGainsTax = capitalGain * corporateTaxRate;
                            }
                        } else { // Individual
                            const capitalGain = currentPropertyValue - (propertyPrice + totalUpfrontCosts);
                            if (capitalGain > 0) {
                                capitalGainsTax = capitalGain * (investmentPeriod >= 5 ? 0.20315 : 0.3963);
                            }
                        }

                        const netSaleProceeds = currentPropertyValue - sellingCosts - finalLoanBalance - capitalGainsTax;
                        cashFlows.push(postTaxAnnualCashFlow + netSaleProceeds);
                    } else {
                        cashFlows.push(postTaxAnnualCashFlow);
                    }
                }

                return {
                    totalInitialInvestment,
                    totalCost,
                    downPaymentAmount,
                    downPaymentRatio,
                    ownCapitalForDownPaymentAmount,
                    creditLoanForDownPaymentAmount,
                    loanAmount,
                    monthlyNetRevenue,
                    totalAnnualExpenses,
                    oneTimeInitialIncome,
                    annualRenewalFee,
                    cashFlows,
                    investmentPeriod,
                    purchaseType,
                    corporateTaxRate,
                    exchangeRate,
                    annualAppreciation,
                    propertyPrice,
                    loanInterestRate,
                    loanTerm,
                    monthlyGrossRevenue,
                    monthlyOperatingExpenses,
                    annualDebtService: (monthlyPayment + creditLoanPayment) * 12,
                    annualManagementFee: monthlyManagementAndRepairs * 12,
                    annualPropertyTax: monthlyPropertyTax * 12,
                    annualInsuranceCost,
                    annualTaxAccountantFee,
                    annualTax_y1,
                    annualTax_y2
                };
            }

            function updateUI(results) {
                const {
                    totalInitialInvestment,
                    totalCost,
                    downPaymentAmount,
                    ownCapitalForDownPaymentAmount,
                    creditLoanForDownPaymentAmount,
                    loanAmount,
                    monthlyNetRevenue,
                    totalAnnualExpenses,
                    oneTimeInitialIncome,
                    annualRenewalFee,
                    cashFlows,
                    investmentPeriod,
                    purchaseType,
                    corporateTaxRate,
                    exchangeRate,
                    annualAppreciation,
                    propertyPrice,
                    loanInterestRate,
                    loanTerm,
                    monthlyGrossRevenue,
                    monthlyOperatingExpenses,
                    annualDebtService,
                    annualManagementFee,
                    annualPropertyTax,
                    annualInsuranceCost,
                    annualTaxAccountantFee,
                    annualTax_y1,
                    annualTax_y2
                } = results;
                const formatManYen = (num) => `${(num / 10000).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 2})} 万円`;
                const formatTWD = (num) => ` ${Math.round(num * exchangeRate).toLocaleString()} 元`;

                document.getElementById('totalInvestmentJPY').textContent = formatManYen(totalInitialInvestment);
                document.getElementById('totalInvestmentTWD').textContent = formatTWD(totalInitialInvestment);
                document.getElementById('totalCostJPY').textContent = formatManYen(totalCost);
                document.getElementById('totalCostTWD').textContent = formatTWD(totalCost);

                document.getElementById('downPaymentOwnCapitalJPY').textContent = formatManYen(ownCapitalForDownPaymentAmount);
                document.getElementById('downPaymentOwnCapitalTWD').textContent = formatTWD(ownCapitalForDownPaymentAmount);
                document.getElementById('downPaymentCreditLoanJPY').textContent = formatManYen(creditLoanForDownPaymentAmount);
                document.getElementById('downPaymentCreditLoanTWD').textContent = formatTWD(creditLoanForDownPaymentAmount);

                document.getElementById('loanAmountJPY').textContent = formatManYen(loanAmount);
                document.getElementById('loanAmountTWD').textContent = formatTWD(loanAmount);

                const firstYearNetRevenue = monthlyNetRevenue * 12 + oneTimeInitialIncome;
                const subsequentYearNetRevenue = monthlyNetRevenue * 12 + annualRenewalFee;
                
                // --- Cash Flow Breakdown Table ---
                const breakdownContainer = document.getElementById('cashFlowBreakdown');
                const annualGrossRevenue = monthlyGrossRevenue * 12;
                const annualOperatingExpenses = monthlyOperatingExpenses * 12;

                let subsequentYearRenewalFee = 0;
                if (document.getElementById('monetizationModel').value === 'personalLease' && investmentPeriod >= 2) {
                    const leaseRenewalFeeFrequency = parseFloat(unformatNumber(document.getElementById('leaseRenewalFeeFrequency').value)) || 2;
                    if (2 % leaseRenewalFeeFrequency === 0) {
                        subsequentYearRenewalFee = annualRenewalFee * leaseRenewalFeeFrequency;
                    }
                }

                breakdownContainer.innerHTML = `
                    <tr class="group-header"><td colspan="3"><strong>收入 (Income)</strong></td></tr>
                    <tr>
                        <td>(+) 年度總營收</td>
                        <td class="positive">${formatManYen(annualGrossRevenue)}</td>
                        <td class="positive">${formatManYen(annualGrossRevenue)}</td>
                    </tr>
                    <tr>
                        <td>(+) 一次性/週期性收入 (禮金/更新料)</td>
                        <td class="positive">${formatManYen(oneTimeInitialIncome)}</td>
                        <td class="positive">${formatManYen(subsequentYearRenewalFee)}</td>
                    </tr>
                    <tr class="group-header"><td colspan="3"><strong>支出 (Expenses)</strong></td></tr>
                    <tr>
                        <td>(-) 營運費用 (平台,清潔,水電等)</td>
                        <td class="negative">-${formatManYen(annualOperatingExpenses)}</td>
                        <td class="negative">-${formatManYen(annualOperatingExpenses)}</td>
                    </tr>
                    <tr>
                        <td>(-) 管理費與修繕金</td>
                        <td class="negative">-${formatManYen(annualManagementFee)}</td>
                        <td class="negative">-${formatManYen(annualManagementFee)}</td>
                    </tr>
                    <tr>
                        <td>(-) 房屋貸款 & 信用貸款</td>
                        <td class="negative">-${formatManYen(annualDebtService)}</td>
                        <td class="negative">-${formatManYen(annualDebtService)}</td>
                    </tr>
                    <tr>
                        <td>(-) 不動產稅 & 保險</td>
                        <td class="negative">-${formatManYen(annualPropertyTax + annualInsuranceCost)}</td>
                        <td class="negative">-${formatManYen(annualPropertyTax + annualInsuranceCost)}</td>
                    </tr>
                    <tr>
                        <td>(-) (法人) 維持費用 (稅理士等)</td>
                        <td class="negative">-${formatManYen(annualTaxAccountantFee)}</td>
                        <td class="negative">-${formatManYen(annualTaxAccountantFee)}</td>
                    </tr>
                    <tr>
                        <td>(-) (法人) 法人稅</td>
                        <td class="negative">-${formatManYen(annualTax_y1)}</td>
                        <td class="negative">-${formatManYen(annualTax_y2)}</td>
                    </tr>
                `;

                // --- Update Final Totals ---
                document.getElementById('netCashFlow_y1').textContent = formatManYen(cashFlows[1]);
                document.getElementById('netCashFlow_y1').className = `value-cell ${cashFlows[1] >= 0 ? 'positive' : 'negative'}`;

                const subsequentCashFlow = investmentPeriod > 1 ? cashFlows[2] : (cashFlows[1] - (oneTimeInitialIncome > 0 ? (oneTimeInitialIncome - (purchaseType === 'corporate' ? oneTimeInitialIncome * corporateTaxRate : 0)) : 0));
                document.getElementById('netCashFlow_y2').textContent = formatManYen(subsequentCashFlow);
                document.getElementById('netCashFlow_y2').className = `value-cell ${subsequentCashFlow >= 0 ? 'positive' : 'negative'}`;

                const cashOnCashReturn_td = document.getElementById('cashOnCashReturn');
                const subsequentYearOperatingCashFlow = subsequentCashFlow;
                const cashOnCashReturn = totalInitialInvestment > 0 ? (subsequentYearOperatingCashFlow / totalInitialInvestment) * 100 : 0;
                cashOnCashReturn_td.textContent = cashOnCashReturn.toFixed(2) + '%';
                cashOnCashReturn_td.className = cashOnCashReturn >= 0 ? 'positive' : 'negative';

                const irr = calculateIRR(cashFlows);
                const totalROI_td = document.getElementById('totalROI');
                totalROI_td.textContent = irr !== null ? (irr * 100).toFixed(2) + '%' : '無法計算';
                totalROI_td.className = irr !== null && irr > 0 ? 'positive' : (irr < 0 ? 'negative' : '');

                const annualTableBody = document.getElementById('annualTableBody');
                annualTableBody.innerHTML = '';
                let tempLoanBalance = loanAmount;
                const monthlyPayment = (loanAmount > 0 && loanTerm > 0) ? (loanInterestRate > 0 ? loanAmount * (loanInterestRate / 12 * Math.pow(1 + loanInterestRate / 12, loanTerm * 12)) / (Math.pow(1 + loanInterestRate / 12, loanTerm * 12) - 1) : loanAmount / (loanTerm * 12)) : 0;

                for (let year = 1; year <= investmentPeriod; year++) {
                    const currentPropertyValue = propertyPrice * Math.pow(1 + annualAppreciation, year);

                    let yearEndLoanBalance = loanAmount;
                    if (loanAmount > 0) {
                        if (loanInterestRate > 0) {
                            yearEndLoanBalance = loanAmount * (Math.pow(1 + loanInterestRate / 12, loanTerm * 12) - Math.pow(1 + loanInterestRate / 12, year * 12)) / (Math.pow(1 + loanInterestRate / 12, loanTerm * 12) - 1);
                        } else {
                            yearEndLoanBalance = loanAmount - (loanAmount / loanTerm) * year;
                        }
                    }

                    const netAssetValue = currentPropertyValue - yearEndLoanBalance;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                         <td>${year}</td>
                         <td class="${cashFlows[year] >= 0 ? 'positive' : 'negative'}">${formatManYen(cashFlows[year])}</td>
                         <td>${formatManYen(currentPropertyValue)}</td>
                         <td>${formatManYen(Math.max(0, yearEndLoanBalance))}</td>
                         <td class="${netAssetValue >= 0 ? 'positive' : 'negative'}">${formatManYen(netAssetValue)}</td>
                     `;
                    annualTableBody.appendChild(row);
                }

                let cumulativeCashFlow = 0;
                let paybackYear = '-';
                for (let i = 1; i <= investmentPeriod; i++) {
                    let operatingCashFlow = cashFlows[i];
                    if (i === investmentPeriod) {
                        const currentPropertyValue = propertyPrice * Math.pow(1 + annualAppreciation, i);
                        const sellingCosts = currentPropertyValue * 0.03;
                        const finalLoanBalance = Math.max(0, loanAmount * (Math.pow(1 + loanInterestRate / 12, loanTerm * 12) - Math.pow(1 + loanInterestRate / 12, i * 12)) / (Math.pow(1 + loanInterestRate / 12, loanTerm * 12) - 1));
                        const capitalGain = currentPropertyValue - (propertyPrice + totalCost - propertyPrice); // totalUpfrontCosts
                        const capitalGainsTax = capitalGain > 0 ? capitalGain * (i >= 5 ? 0.20315 : 0.3963) : 0;
                        const netSaleProceeds = currentPropertyValue - sellingCosts - finalLoanBalance - capitalGainsTax;
                        operatingCashFlow -= netSaleProceeds;
                    }
                    cumulativeCashFlow += operatingCashFlow;
                    if (cumulativeCashFlow >= totalInitialInvestment && paybackYear === '-') {
                        paybackYear = i;
                    }
                }
                document.getElementById('paybackPeriod').textContent = paybackYear !== '-' ? paybackYear + ' 年' : '> ' + investmentPeriod + ' 年';
            }

            function generateSuggestions(results) {
                const {
                    cashFlows,
                    investmentPeriod,
                    oneTimeInitialIncome,
                    purchaseType,
                    corporateTaxRate,
                    downPaymentRatio,
                    loanInterestRate
                } = results;
                const loanAmount = results.loanAmount;
                const suggestionsContainer = document.getElementById('expertSuggestions');
                const suggestionTextDiv = document.getElementById('suggestionText');

                const postTaxOneTimeInitialIncome = oneTimeInitialIncome > 0 ? (oneTimeInitialIncome - (purchaseType === 'corporate' ? oneTimeInitialIncome * corporateTaxRate : 0)) : 0;
                const subsequentCashFlow = investmentPeriod > 1 ? cashFlows[2] : (cashFlows[1] - postTaxOneTimeInitialIncome);

                let suggestionsHTML = '';
                if (subsequentCashFlow < 0) {
                    const monetizationModel = document.getElementById('monetizationModel').value;
                    const location = document.getElementById('location').options[document.getElementById('location').selectedIndex].text;
                    const propertyType = document.getElementById('propertyType').options[document.getElementById('propertyType').selectedIndex].text;

                    suggestionsHTML += `<p><strong>警示：您的續年現金流為負數 (每年約 <span class="negative">${(subsequentCashFlow/10000).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 2})} 万円</span>)</strong>，代表在持有期間可能需要持續投入資金以維持運營。以下是一些可能的優化方向：</p><ul>`;
                    if (monetizationModel === 'airbnb') {
                        const adr = parseFloat(unformatNumber(document.getElementById('dailyRate').value));
                        suggestionsHTML += `<li><strong>提高營收：</strong> 您目前的ADR設定為 <strong>${adr.toLocaleString()}円</strong>。建議參考市場競爭情況，嘗試適度提高ADR或旺季加成比例，並優化追加人頭費策略以提升總營收。</li>`;
                    } else {
                        const rent = monetizationModel === 'personalLease' ? parseFloat(unformatNumber(document.getElementById('monthlyRent').value)) : parseFloat(unformatNumber(document.getElementById('monthlyRentCommercial').value));
                        suggestionsHTML += `<li><strong>提高租金：</strong> 您目前的月租金設定為 <strong>${rent.toLocaleString()}万円</strong>。請確認此價格在「${location}」是否具備競爭力。適度提高租金是改善現金流最直接的方式。</li>`;
                    }
                    if (loanAmount > 0 && downPaymentRatio < 0.5) {
                        suggestionsHTML += `<li><strong>降低貸款壓力：</strong> 您目前的頭期款比例為 <strong>${downPaymentRatio * 100}%</strong>。若資金允許，提高頭期款至30%或更高，能顯著降低每月的房貸還款額。</li>`;
                    }
                    if (loanAmount > 0) {
                        suggestionsHTML += `<li><strong>尋找更低利率：</strong> 您目前的貸款利率為 <strong>${loanInterestRate * 100}%</strong>。日本市場上或許存在更優惠的貸款方案，建議積極與多家銀行洽談，爭取更低的利率。</li>`;
                    }
                    suggestionsHTML += `<li><strong>重新評估標的：</strong> 您選擇的是「${location}」的「${propertyType}」。若追求短期現金流，可考慮尋找總價較低或租金回報率更高的區域/房型，以優化投報結構。</li>`;
                    suggestionsHTML += `</ul><hr style="margin: 20px 0;">`;
                }

                suggestionsHTML += '<p><strong>專家提醒注意事項：</strong></p><ul>';
                const monetizationModel = document.getElementById('monetizationModel').value;
                const loanOrigin = document.getElementById('loanOrigin').value;

                if (monetizationModel === 'airbnb') {
                    suggestionsHTML += '<li><strong>法規遵循：</strong> 請務必確認物件符合《住宅宿泊事業法》(民泊新法) 或《旅館業法》的規定。東京23區對民泊新法的「180天上限」有額外限制（如僅限週末營業），可能影響實際營收。</li>';
                    suggestionsHTML += '<li><strong>營運強度：</strong> Airbnb屬於高強度營運模式，需投入大量心力在與房客溝通、維持清潔品質及管理網路評價上，才能維持高入住率與高單價。</li>';
                    suggestionsHTML += '<li><strong>費用波動：</strong> 水電瓦斯費用（光熱費）會因旅客使用習慣而大幅波動，冬季暖氣與夏季冷氣的費用通常遠高於平均值，建議預算應更為寬鬆。</li>';
                } else if (monetizationModel === 'personalLease') {
                    suggestionsHTML += '<li><strong>租客風險：</strong> 長租模式需注意租客風險，如租金拖欠、提前解約、或對房產造成損壞。加入「家賃保証会社」(租金保證公司) 是降低此風險的關鍵。</li>';
                    suggestionsHTML += '<li><strong>原狀回復：</strong> 租客退租時的「原状回復」費用分攤是常見爭議點。務必在契約中明確規定，並與可靠的管理公司合作處理，避免不必要的糾紛與開銷。</li>';
                    suggestionsHTML += '<li><strong>更新料收入：</strong> 您已設定收取更新料，這是長租模式的重要額外收入。請注意，並非所有地區都有此慣例，且此收入並非每年發生，需納入長期現金流規劃。</li>';
                } else { // Commercial Lease
                    suggestionsHTML += '<li><strong>高風險高回報：</strong> 店鋪租賃的空置期通常比住宅更長，且更換租客的成本（招租、裝修補助等）更高。其成功與否高度依賴地點與租客的行業類別。</li>';
                    suggestionsHTML += '<li><strong>契約複雜性：</strong> 事業用租賃契約比住宅契約複雜得多，建議務必請專業人士（如代書、律師）審閱，確保自身權益。</li>';
                }

                if (purchaseType === 'corporate') {
                    suggestionsHTML += '<li><strong>法人維運成本：</strong> 透過法人購屋雖能擴大費用認列範圍（如本次新增的稅理士費用），但同時也產生了公司設立與後續維護的成本，需一併考量。</li>';
                }

                if (loanOrigin !== 'japan') {
                    suggestionsHTML += '<li><strong>匯率風險 (為替リスク)：</strong> 若從台灣貸款或匯款來支付頭期款，您的投資將暴露在匯率風險之下。日幣貶值時雖有利於將獲利匯回，但升值時會增加您的還款壓力或侵蝕獲利，需有對應的風險規劃。</li>';
                }

                suggestionsHTML += '<li><strong>建物長期修繕計畫：</strong> 購買前，務必向管理公司索取該建物的「長期修繕計画書」，了解未來是否有大型修繕計畫（如外牆、電梯更新），這可能導致管理費與修繕金的大幅上調。</li>';
                suggestionsHTML += '<li><strong>最終提醒：</strong> 本分析工具為一財務模型，所有預設值與計算結果僅供參考。最終投資決策應基於實地考察、專業顧問諮詢、以及對個別物件的詳細盡職調查。</li>';

                suggestionsHTML += '</ul>';

                suggestionTextDiv.innerHTML = suggestionsHTML;
                suggestionsContainer.classList.remove('hidden');
            }

            function calculateIRR(cashFlows) {
                const maxIterations = 1000;
                const precision = 1e-7;
                let guessLow = -0.99,
                    guessHigh = 1.0;
                if (calculateNPV(cashFlows, guessLow) * calculateNPV(cashFlows, guessHigh) > 0) return null;
                for (let i = 0; i < maxIterations; i++) {
                    let mid = (guessLow + guessHigh) / 2;
                    if (mid === guessLow || mid === guessHigh) return mid;
                    let npvMid = calculateNPV(cashFlows, mid);
                    if (Math.abs(npvMid) < precision) return mid;
                    if (calculateNPV(cashFlows, guessLow) * npvMid < 0) {
                        guessHigh = mid;
                    } else {
                        guessLow = mid;
                    }
                }
                return (guessLow + guessHigh) / 2;
            }

            function calculateNPV(cashFlows, rate) {
                let npv = 0;
                for (let i = 0; i < cashFlows.length; i++) {
                    npv += cashFlows[i] / Math.pow((1 + rate), i);
                }
                return npv;
            }

            // --- INITIAL SETUP ---
            const inputsToFormat = [
                'propertyPrice', 'initialFurnishingCost', 'corporateSetupCost', 'dailyRate', 'cleaningFee',
                'extraGuestFee', 'monthlyUtilities', 'monthlyRent', 'leaseUtilities',
                'monthlyRentCommercial', 'annualInsuranceCost', 'annualTaxAccountantFee', 'ownCapitalAmount'
            ];
            inputsToFormat.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('focus', unformatOnFocus);
                    input.addEventListener('blur', formatOnBlur);
                }
            });

            purchaseTypeSelect.dispatchEvent(new Event('change'));
            loanOriginSelect.dispatchEvent(new Event('change'));
            monetizationModelSelect.dispatchEvent(new Event('change'));
        });
    </script>
</body>
</html> 