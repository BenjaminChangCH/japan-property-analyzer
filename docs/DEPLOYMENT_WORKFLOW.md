# ğŸš€ é–‹ç™¼èˆ‡éƒ¨ç½²å·¥ä½œæµç¨‹æŒ‡å— (Development & Deployment Workflow)

## ğŸ¯ **æµç¨‹æ ¸å¿ƒåŸå‰‡**
æˆ‘å€‘æ¡ç”¨ **STG (æ¸¬è©¦ç’°å¢ƒ) â†’ PRD (ç”Ÿç”¢ç’°å¢ƒ)** çš„é›™ç’°å¢ƒéƒ¨ç½²ç­–ç•¥ï¼Œä¸¦ä»¥è‡ªå‹•åŒ–ç‚ºæ ¸å¿ƒï¼Œç¢ºä¿æ‰€æœ‰éƒ¨ç½²éƒ½ç¶“éé©—è­‰ï¼Œä¿éšœç”Ÿç”¢ç’°å¢ƒçš„ç©©å®šæ€§ã€‚

```mermaid
graph TD
    A[ğŸ‘¨â€ğŸ’» åŠŸèƒ½é–‹ç™¼] --> B[ğŸ“ å‰µå»º Pull Request]
    B --> C[âš™ï¸ è‡ªå‹• STG éƒ¨ç½²]
    C --> D[ğŸ§ª STG æ¸¬è©¦é©—è­‰]
    D --> E{âœ… æ¸¬è©¦é€šé?}
    E -->|æ˜¯| F[ğŸ”„ åˆä½µåˆ° main]
    E -->|å¦| G[ğŸ ä¿®å¾©å•é¡Œ]
    G --> B
    F --> H[ğŸš€ è‡ªå‹• PRD éƒ¨ç½²]
    H --> I[ğŸ©º PRD å¥åº·æª¢æŸ¥]
    I --> J[ğŸ‰ ç™¼ä½ˆå®Œæˆ]
```

## ğŸ“ **è©³ç´°æµç¨‹æ­¥é©Ÿ**

---
### **éšæ®µ 1: åŠŸèƒ½é–‹ç™¼**

#### **1. ç’°å¢ƒæº–å‚™èˆ‡å»ºç«‹åˆ†æ”¯**
åœ¨é–‹å§‹ä»»ä½•é–‹ç™¼å‰ï¼Œè«‹å…ˆç¢ºä¿æ‚¨çš„ `main` åˆ†æ”¯æ˜¯æœ€æ–°ç‹€æ…‹ã€‚

```bash
# 1. åˆ‡æ›åˆ° main åˆ†æ”¯
git checkout main

# 2. æ‹‰å–é ç«¯æœ€æ–°è®Šæ›´
git pull origin main

# 3. æ ¹æ“šåŠŸèƒ½æˆ–ä¿®å¾©ç›®çš„ï¼Œå»ºç«‹æ–°åˆ†æ”¯
# å‘½åè¦å‰‡: feature/åŠŸèƒ½, fix/å•é¡Œ, hotfix/ç·Šæ€¥ä¿®å¾©
git checkout -b feature/add-new-calculation
```

#### **2. ç·¨ç¢¼èˆ‡æœ¬åœ°æ¸¬è©¦**
åœ¨æ­¤éšæ®µé€²è¡Œç¨‹å¼ç¢¼çš„æ’°å¯«èˆ‡ä¿®æ”¹ã€‚

```bash
# é–‹ç™¼å®Œæˆå¾Œï¼Œè«‹å‹™å¿…åœ¨æœ¬åœ°é€²è¡Œåˆæ­¥æ¸¬è©¦
python main.py
```

#### **3. å“è³ªæª¢æŸ¥èˆ‡æäº¤**
åœ¨æäº¤ç¨‹å¼ç¢¼å‰ï¼ŒåŸ·è¡Œå“è³ªæª¢æŸ¥è…³æœ¬ä»¥ç¢ºä¿ç¨‹å¼ç¢¼é¢¨æ ¼èˆ‡å“è³ªç¬¦åˆæ¨™æº–ã€‚

```bash
# åŸ·è¡Œå“è³ªæª¢æŸ¥
python scripts/quality_checker.py

# å°‡è®Šæ›´åŠ å…¥æš«å­˜å€
git add .

# éµå¾ªè¦ç¯„æ’°å¯«æäº¤è¨Šæ¯
git commit -m "feat: æ–°å¢é¢¨éšªåˆ†æåŠŸèƒ½"
```

---
### **éšæ®µ 2: STG éƒ¨ç½²èˆ‡æ¸¬è©¦**

#### **1. è§¸ç™¼ STG éƒ¨ç½²**
å°‡æ‚¨çš„åˆ†æ”¯æ¨é€åˆ°é ç«¯ï¼Œä¸¦åœ¨ GitHub ä¸Šå»ºç«‹ä¸€å€‹æŒ‡å‘ `main` åˆ†æ”¯çš„ Pull Request (PR)ã€‚

```bash
# æ¨é€æ‚¨çš„åŠŸèƒ½åˆ†æ”¯
git push origin feature/add-new-calculation
```
**æ­¤æ“ä½œæœƒè‡ªå‹•è§¸ç™¼ CI/CD æµç¨‹ï¼Œå°‡æ‚¨çš„è®Šæ›´éƒ¨ç½²åˆ° STG ç’°å¢ƒã€‚**

#### **2. STG ç’°å¢ƒæ¸¬è©¦é©—è­‰**
æ‚¨å¿…é ˆåœ¨ STG ç’°å¢ƒä¸­æ‰‹å‹•é©—è­‰æ‚¨çš„è®Šæ›´ï¼Œç¢ºä¿æ–°åŠŸèƒ½æ­£å¸¸ä¸”æœªå½±éŸ¿ç¾æœ‰åŠŸèƒ½ã€‚

**STG ç’°å¢ƒè³‡è¨Š:**
-   **æ‡‰ç”¨ç¨‹å¼ URL**: `https://japan-property-analyzer-stg-366005894157.asia-east1.run.app`
-   **å¥åº·æª¢æŸ¥ URL**: `https://japan-property-analyzer-stg-366005894157.asia-east1.run.app/health`

**STG æ¸¬è©¦æª¢æŸ¥æ¸…å–®ï¼š**
- [ ] **åŠŸèƒ½æ¸¬è©¦**: æ–°åŠŸèƒ½æ­£å¸¸é‹ä½œ
- [ ] **å›æ­¸æ¸¬è©¦**: ç¾æœ‰åŠŸèƒ½æœªå—å½±éŸ¿
- [ ] **API æ¸¬è©¦**: æ‰€æœ‰ç«¯é»æ­£å¸¸å›æ‡‰ (å¦‚æœ‰)
- [ ] **ä½¿ç”¨è€…é«”é©—**: UI/UX ç¬¦åˆè¨­è¨ˆ

**å•é¡Œæ’æŸ¥ï¼š**
å¦‚æœ STG æ¸¬è©¦å¤±æ•—ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤æŸ¥çœ‹æ—¥èªŒï¼š
```bash
# æª¢æŸ¥ STG ç’°å¢ƒæ—¥èªŒ
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=japan-property-analyzer-stg" --limit=50
```

---
### **éšæ®µ 3: PRD éƒ¨ç½² (åˆä½µè‡³ `main`)**

#### **1. PRD éƒ¨ç½²å‰æª¢æŸ¥é»**
åœ¨åˆä½µ PR å‰ï¼Œè«‹å‹™å¿…ç¢ºèªï¼š
- âœ… **STG æ¸¬è©¦å®Œå…¨é€šé**
- âœ… **PR å·²ç²å¾—è‡³å°‘ä¸€ä½åŒäº‹çš„å¯©æ ¸æ‰¹å‡† (Code Review)**
- âœ… **ç‰ˆæœ¬è™Ÿå·²æ ¹æ“š `VERSION_CONTROL_GUIDE.md` çš„è¦ç¯„æ­£ç¢ºæ›´æ–°**
- âœ… **ç„¡é«˜é¢¨éšªçš„å®‰å…¨å•é¡Œ**

#### **2. è§¸ç™¼ PRD éƒ¨ç½²**
åœ¨ GitHub ä¸Šé»æ“Š **"Merge Pull Request"** å°‡æ‚¨çš„åˆ†æ”¯åˆä½µåˆ° `main`ã€‚

**æ­¤æ“ä½œæœƒè‡ªå‹•è§¸ç™¼ CI/CD æµç¨‹ï¼Œå°‡æœ€æ–°çš„ `main` åˆ†æ”¯ç¨‹å¼ç¢¼éƒ¨ç½²åˆ° PRD ç’°å¢ƒã€‚**

---
### **éšæ®µ 4: ç™¼ä½ˆå®Œæˆèˆ‡é©—è­‰**

éƒ¨ç½²å®Œæˆå¾Œï¼Œè«‹å°ç”Ÿç”¢ç’°å¢ƒé€²è¡Œå¿«é€Ÿé©—è­‰ã€‚

**PRD ç’°å¢ƒè³‡è¨Š:**
-   **æ‡‰ç”¨ç¨‹å¼ URL**: `https://japan-property-analyzer-prod-864942598341.asia-northeast1.run.app`
-   **å¥åº·æª¢æŸ¥ URL**: `https://japan-property-analyzer-prod-864942598341.asia-northeast1.run.app/health`

**éƒ¨ç½²å¾Œé©—è­‰ï¼š**
- [ ] **æœå‹™å¯ç”¨æ€§**: PRD ç’°å¢ƒå¯æ­£å¸¸è¨ªå•
- [ ] **åŠŸèƒ½é©—è­‰**: æŠ½æŸ¥ä¸€è‡³å…©é …é—œéµåŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œ
- [ ] **ç›£æ§æª¢æŸ¥**: ç¢ºèª GCP Monitoring ç„¡ç•°å¸¸å‘Šè­¦

## ğŸš¨ **ç·Šæ€¥è™•ç†ç¨‹åº**

### **å›æ»¾æ“ä½œ (Rollback)**
å¦‚æœç”Ÿç”¢ç’°å¢ƒç™¼ç”Ÿåš´é‡å•é¡Œï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å›æ»¾è‡³ä¸Šä¸€å€‹ç©©å®šç‰ˆæœ¬ã€‚

1.  **GitHub Actions æ‰‹å‹•è§¸ç™¼**
    -   å‰å¾€ Actions â†’ `Production Deployment`
    -   é¸æ“‡ "Run workflow" ä¸¦æŒ‡å®šè¦å›æ»¾çš„ç‰ˆæœ¬æ¨™ç±¤ã€‚
2.  **å‘½ä»¤åˆ—å›æ»¾** (åƒ…åœ¨è‡ªå‹•åŒ–æµç¨‹å¤±æ•ˆæ™‚ä½¿ç”¨)
    ```bash
    # è«‹å°‡ PREVIOUS_REVISION æ›¿æ›ç‚ºè¦æ¢å¾©çš„ä¿®è¨‚ç‰ˆæœ¬è™Ÿ
    gcloud run services update-traffic japan-property-analyzer-prod \
      --region=asia-northeast1 \
      --to-revisions=PREVIOUS_REVISION=100
    ```

### **ç·Šæ€¥ä¿®å¾©æµç¨‹ (Hotfix)**
ç·Šæ€¥ä¿®å¾©ä¹Ÿå¿…é ˆéµå¾ª **PR -> STG -> PRD** çš„æµç¨‹ï¼Œä½†å¯©æ ¸æµç¨‹å¯ä»¥åŠ é€Ÿã€‚
```bash
# 1. å¾ main å»ºç«‹ hotfix åˆ†æ”¯
git checkout main
git pull origin main
git checkout -b hotfix/critical-security-patch

# 2. å¿«é€Ÿä¿®å¾©ã€æäº¤ã€æ¨é€
# ...
git push origin hotfix/critical-security-patch

# 3. å»ºç«‹ PRï¼Œå¿«é€Ÿå®Œæˆ STG æ¸¬è©¦èˆ‡åˆä½µ
```

## âš ï¸ **åš´æ ¼éµå¾ªæµç¨‹ - é˜²ç¯„é•è¦**

### ğŸš¨ **çµ•å°ç¦æ­¢çš„æ“ä½œ**
**âŒ ç¦æ­¢ç›´æ¥æ¨é€ (Push) åˆ° `main` åˆ†æ”¯!** é€™æœƒç¹é STG çš„æ¸¬è©¦å’Œ PR çš„ç¨‹å¼ç¢¼å¯©æ ¸ï¼Œå¸¶ä¾†æ¥µé«˜é¢¨éšªã€‚

```bash
# ğŸš¨ ä»¥ä¸‹æ“ä½œæ˜¯çµ•å°ç¦æ­¢çš„ï¼
git checkout main
git commit -m "some quick fix"
git push origin main
```
**åˆ†æ”¯ä¿è­·è¦å‰‡å·²å•Ÿç”¨ï¼Œæ­¤æ“ä½œå°‡æœƒè¢«é˜»æ­¢ã€‚** æ‰€æœ‰è®Šæ›´éƒ½å¿…é ˆé€é Pull Request æµç¨‹ã€‚

## âš¡ **å¿«é€Ÿå‘½ä»¤åƒè€ƒ**

### **æ—¥å¸¸é–‹ç™¼**
```bash
# é–‹å§‹æ–°åŠŸèƒ½
git checkout main && git pull origin main && git checkout -b feature/new-feature

# æäº¤è®Šæ›´
git add . && git commit -m "feat: åŠŸèƒ½æè¿°"
git push origin feature/new-feature
```

### **å•é¡Œæ’æŸ¥**
```bash
# æª¢æŸ¥ç‰ˆæœ¬è³‡è¨Š
python -c "from version import get_version_info; print(get_version_info())"

# æª¢æŸ¥ PRD æœå‹™å¥åº·ç‹€æ…‹
curl https://japan-property-analyzer-prod-864942598341.asia-northeast1.run.app/health

# æŸ¥çœ‹æœ€è¿‘çš„æäº¤ç´€éŒ„
git log --oneline -5
```

## ğŸ› ï¸ **æ‰‹å‹•ç™¼ä½ˆå·¥å…·**

### **ç‰ˆæœ¬ç®¡ç†**
```bash
# æŸ¥çœ‹ç‰ˆæœ¬ç‹€æ…‹
python scripts/version_manager.py status

# ç™¼ä½ˆæ–°ç‰ˆæœ¬
python scripts/version_manager.py release patch "ä¿®å¾©ç¨‹å¼éŒ¯èª¤"
python scripts/version_manager.py release minor "æ–°å¢åŠŸèƒ½"
python scripts/version_manager.py release major "é‡å¤§æ›´æ–°"
```

### **å‚™ä»½ç®¡ç†**
```bash
# å‰µå»ºä»£ç¢¼å‚™ä»½
python scripts/backup_manager.py backup

# æŸ¥çœ‹å‚™ä»½åˆ—è¡¨
python scripts/backup_manager.py list

# æ¸…ç†èˆŠå‚™ä»½
python scripts/backup_manager.py cleanup
```

## ğŸ“Š **ç›£æ§èˆ‡å‘Šè­¦**

### **éƒ¨ç½²ç›£æ§æŒ‡æ¨™**
- éƒ¨ç½²æˆåŠŸç‡
- éƒ¨ç½²æ™‚é–“
- å›æ»¾é »ç‡
- å¥åº·æª¢æŸ¥é€šéç‡

### **é—œéµå‘Šè­¦è¨­å®š**
- PRD æœå‹™ä¸å¯ç”¨
- éŒ¯èª¤ç‡è¶…éé–¾å€¼
- å›æ‡‰æ™‚é–“ç•°å¸¸
- è¨˜æ†¶é«”/CPU ä½¿ç”¨éé«˜

## ğŸ” **å®‰å…¨æª¢æŸ¥æ¸…å–®**

### **éƒ¨ç½²å‰æª¢æŸ¥**
- [ ] ä¾è³´å¥—ä»¶ç„¡é«˜å±æ¼æ´
- [ ] å¯†é‘°å’Œè¨­å®šæª”æœªæš´éœ²
- [ ] API ç«¯é»å…·å‚™é©ç•¶é©—è­‰
- [ ] è¼¸å…¥é©—è­‰æ©Ÿåˆ¶å®Œå‚™

### **éƒ¨ç½²å¾Œé©—è­‰**
- [ ] HTTPS æ†‘è­‰æœ‰æ•ˆ
- [ ] å®‰å…¨æ¨™é ­è¨­å®šæ­£ç¢º
- [ ] éŒ¯èª¤è¨Šæ¯ä¸æ´©éœ²æ•æ„Ÿè³‡è¨Š
- [ ] æ—¥èªŒè¨˜éŒ„ç¬¦åˆåˆè¦è¦æ±‚

## ğŸ“ˆ **æŒçºŒæ”¹å–„**

### **å®šæœŸæª¢è¨é …ç›®**
- éƒ¨ç½²æµç¨‹æ•ˆç‡
- æ¸¬è©¦è¦†è“‹ç‡
- éŒ¯èª¤ç™¼ç”Ÿç‡
- åœ˜éšŠå›é¥‹æ„è¦‹

### **æœ€ä½³å¯¦è¸**
1. **å°æ­¥å¿«è·‘**: é »ç¹å°é‡éƒ¨ç½²
2. **è‡ªå‹•åŒ–å„ªå…ˆ**: æ¸›å°‘äººå·¥æ“ä½œ
3. **ç›£æ§é©…å‹•**: æ•¸æ“šæ”¯æ’æ±ºç­–
4. **å¿«é€Ÿå›æ»¾**: å•é¡Œå¿«é€Ÿæ¢å¾©

---

## ğŸ†˜ **æ”¯æ´è¯çµ¡**

å¦‚æœ‰éƒ¨ç½²å•é¡Œï¼Œè«‹è¯çµ¡ï¼š
- **æŠ€è¡“æ”¯æ´**: [æŠ€è¡“åœ˜éšŠè¯çµ¡æ–¹å¼]
- **ç·Šæ€¥è¯çµ¡**: [24/7 æ”¯æ´è¯çµ¡æ–¹å¼]
- **æ–‡ä»¶å•é¡Œ**: [æ–‡ä»¶ç¶­è­·åœ˜éšŠ]

å‰å¾€: https://github.com/BenjaminChangCH/japan-property-analyzer/pull/new/hotfix/dockerfile-syntax-fix
